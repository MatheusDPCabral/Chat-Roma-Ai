<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat Socket.IO</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="/css/chat.css" />
</head>

<body>
    <div class="chat-container">
        <div class="card shadow-lg p-3 h-100">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <label class="switch">
                    <input type="checkbox" id="darkModeToggle" onclick="toggleDarkMode()" />
                    <span class="slider round"></span>
                </label>
                <div class="dropdown">
                    <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownUsers" data-bs-toggle="dropdown" aria-expanded="false">
                        CHAT
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="dropdownUsers" id="onlineUsersList"></ul>
                </div>
                <span id="personName"></span>
            </div>

            <div class="card-body chat-box">
                <ul class="list-unstyled" id="messagesList"></ul>
            </div>

            <div class="input-group mt-3">
                <input type="text" id="message" class="form-control" placeholder="Digite sua mensagem" />
                <button class="btn btn-success" onclick="enviar()">Enviar</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const socket = io("http://localhost:4001/");
        let onlineUsers = [];
        let loadingMessageId = null; // Armazena o ID da mensagem de carregamento

        const urlParams = new URLSearchParams(window.location.search);
        const username = urlParams.get('user') || "user-chat";
        document.getElementById("personName").textContent = username;
        socket.emit("newUser", username);

        socket.on("message", (msg) => {
            const ul = document.getElementById("messagesList");
            const li = document.createElement("li");

            const nameDiv = document.createElement("div");
            nameDiv.classList.add("username");
            nameDiv.textContent = msg.username === username ? "Eu" : msg.username;

            const msgDiv = document.createElement("div");
            msgDiv.classList.add("message-content");

            if (msg.message.startsWith("http")) { 
                const img = document.createElement("img");
                img.src = msg.message;
                img.alt = "Imagem gerada";
                img.style.maxWidth = "100%";
                msgDiv.appendChild(img);
            } else {
                msgDiv.textContent = msg.message;
                
                // Verifica se a mensagem é um comando especial e toca o som correspondente
                const sounds = {
                    "/miau": '/sounds/gato-miando.mp3',
                    "/risada": '/sounds/gato-rindo.mp3',
                    "/mario": '/sounds/super-mario-death.mp3',
                    "/aplausos": '/sounds/aplausos.mp3',
                    "/neymar": '/sounds/boa-tarde-neymar.mp3'
                };
                if (sounds[msg.message]) {
                    const sound = new Audio(sounds[msg.message]);
                    sound.play();
                }
            }

            if (msg.username === username) {
                li.classList.add("sent");
            } else {
                li.classList.add("received");
            }

            li.appendChild(nameDiv);
            li.appendChild(msgDiv);
            ul.appendChild(li);
            ul.scrollTop = ul.scrollHeight;

            // Remove o "Loading..." quando a resposta é recebida
            removeLoadingMessage();
        });

        socket.on("userList", (users) => {
            onlineUsers = users;
            updateUsersDropdown();
        });

        function updateUsersDropdown() {
            const userList = document.getElementById("onlineUsersList");
            userList.innerHTML = "";
            onlineUsers.forEach((user) => {
                const li = document.createElement("li");
                li.textContent = user === username ? `${user} (você)` : user;
                li.classList.add("dropdown-item");
                userList.appendChild(li);
            });
        }

        async function enviar() {
            let msg = document.querySelector("#message").value;

            if (msg.trim() !== "") {
                // Adiciona "Loading..." ao chat antes de enviar o comando para a API
                if (msg.startsWith("/cat") || msg.startsWith("/dog") || msg.startsWith("/fox") || msg.startsWith("/image") || msg.startsWith("/text") || msg.startsWith("/pokemon")) {
                    addLoadingMessage();
                }

                socket.emit("message", {
                    username: username,
                    message: msg,
                });

                document.querySelector("#message").value = "";
            } else {
                alert("Por favor, insira uma mensagem.");
            }
        }

        function addLoadingMessage() {
            const ul = document.getElementById("messagesList");
            const li = document.createElement("li");
            li.classList.add("received");

            const nameDiv = document.createElement("div");
            nameDiv.classList.add("username");
            nameDiv.textContent = "Carregando...";

            const msgDiv = document.createElement("div");
            msgDiv.classList.add("message-content");
            msgDiv.textContent = "Aguardando resposta da API...";

            li.appendChild(nameDiv);
            li.appendChild(msgDiv);
            li.id = "loadingMessage"; // Define um ID para a mensagem de carregamento
            ul.appendChild(li);

            loadingMessageId = li.id; // Armazena o ID para referência futura
        }

        function removeLoadingMessage() {
            if (loadingMessageId) {
                const loadingMessage = document.getElementById(loadingMessageId);
                if (loadingMessage) {
                    loadingMessage.remove();
                }
                loadingMessageId = null; // Reseta o ID após remover
            }
        }

        document.getElementById("message").addEventListener("keypress", function (event) {
            if (event.key === "Enter") {
                event.preventDefault();
                enviar();
            }
        });

        function toggleDarkMode() {
            document.body.classList.toggle("dark-mode");
        }
    </script>
</body>
</html>
