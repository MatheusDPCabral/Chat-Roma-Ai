<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat Socket.IO</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="/css/chat.css" />
</head>

<body>
    <div class="chat-container">
        <div class="card shadow-lg p-3 h-100">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <label class="switch">
                    <input type="checkbox" id="darkModeToggle" onclick="toggleDarkMode()" />
                    <span class="slider round"></span>
                </label>
                <span id="personName"></span>
            </div>

            <div class="card-body chat-box">
                <ul class="list-unstyled" id="messagesList"></ul>
            </div>

            <div class="input-group mt-3">
                <input type="text" id="message" class="form-control" placeholder="Digite sua mensagem" />
                <button class="btn btn-success" onclick="enviar()">
                    Enviar
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const socket = io("https://super-space-fiesta-r97xv6gjgw53pqw7-4001.app.github.dev/"); // Atualize o URL para o servidor local, se necessário
        let onlineUsers = [];

        // Carrega o nome de usuário da URL
        const urlParams = new URLSearchParams(window.location.search);
        const username = urlParams.get('user') || "user-chat";
        document.getElementById("personName").textContent = username;
        socket.emit("newUser", username);

        socket.on("message", (msg) => {
            const ul = document.getElementById("messagesList");
            const li = document.createElement("li");

            const nameDiv = document.createElement("div");
            nameDiv.classList.add("username");
            nameDiv.textContent =
                msg.username === username
                    ? "Eu"
                    : msg.username;

            const msgDiv = document.createElement("div");
            msgDiv.classList.add("message-content");

            // Verificando se é um comando
            if (msg.message === "/help") {
                const helpMessage = `Comandos disponíveis:
    /fox - Retorna uma imagem aleatória de raposa.
    /dog - Retorna uma imagem aleatória de cachorro.
    /cat - Retorna uma imagem aleatória de gato.
    /pokemon - Retorna uma imagem aleatória de um Pokémon.
    /image <descrição> - Gera uma imagem com base na descrição fornecida (utiliza a API do OpenAI).
    /text <mensagem> - Responde com um texto gerado pela API do OpenAI com base na mensagem fornecida.
    /miau - Toca o som de um gato miando.
    /risada - Toca um som de risada.
    /mario - Toca o som da morte do Mario no jogo.
    /aplausos - Toca o som de aplausos.
    /neymar - Toca o áudio com a frase "Boa tarde, Neymar!".`;
                msgDiv.textContent = helpMessage; // Exibe a lista de comandos
            } else if (msg.message.startsWith("http")) { // Verifica se é uma URL
                const img = document.createElement("img");
                img.src = msg.message;
                img.alt = "Imagem gerada";
                img.style.maxWidth = "100%"; // Adiciona limite de largura
                msgDiv.appendChild(img);
            } else {
                msgDiv.textContent = msg.message;

                // Verificando comandos e tocando os sons correspondentes
                if (msg.message === "/fox") {
                    socket.emit("playSound", "/sounds/fox.mp3"); // Enviar para o servidor o evento para tocar o som da raposa
                } else if (msg.message === "/dog") {
                    socket.emit("playSound", "/sounds/dog.mp3"); // Enviar para o servidor o evento para tocar o som do cachorro
                } else if (msg.message === "/cat") {
                    socket.emit("playSound", "/sounds/cat.mp3"); // Enviar para o servidor o evento para tocar o som do gato
                }

                // Adiciona a lógica para reprodução de sons
                if (msg.message === "/miau") {
                    const sound = new Audio('/sounds/gato-miando.mp3');
                    sound.play();
                } else if (msg.message === "/risada") {
                    const sound = new Audio('/sounds/gato-rindo.mp3');
                    sound.play();
                } else if (msg.message === "/mario") {
                    const sound = new Audio('/sounds/super-mario-death.mp3');
                    sound.play();
                } else if (msg.message === "/aplausos") {
                    const sound = new Audio('/sounds/aplausos.mp3');
                    sound.play();
                } else if (msg.message === "/neymar") {
                    const sound = new Audio('/sounds/boa-tarde-neymar.mp3');
                    sound.play();
                }
            }

            if (msg.username === username) {
                li.classList.add("sent");
            } else {
                li.classList.add("received");
            }

            li.appendChild(nameDiv);
            li.appendChild(msgDiv);
            ul.appendChild(li);
            ul.scrollTop = ul.scrollHeight;
        });

        socket.on("userList", (users) => {
            onlineUsers = users;
            updateUsersDropdown();
        });

        function updateUsersDropdown() {
            const userList = document.getElementById("onlineUsersList");
            userList.innerHTML = "";
            onlineUsers.forEach((user) => {
                const li = document.createElement("li");
                li.textContent =
                    user === username
                        ? `${user} (você)`
                        : user;
                li.classList.add("dropdown-item");
                userList.appendChild(li);
            });
        }

        async function enviar() {
            let msg = document.querySelector("#message").value;

            if (msg.trim() !== "") {
                socket.emit("message", {
                    username: username,
                    message: msg,
                });
                document.querySelector("#message").value = "";
            } else {
                alert("Por favor, insira uma mensagem.");
            }
        }

        document.getElementById("message").addEventListener("keypress", function (event) {
            if (event.key === "Enter") {
                event.preventDefault();
                enviar();
            }
        });

        function toggleDarkMode() {
            document.body.classList.toggle("dark-mode");
        }
    </script>
</body>

</html>
